#jinja2: trim_blocks: True, lstrip_blocks: True
{###########################################

Purpose:
Configure BGP commands for dellos10 Devices

dellos_bgp:
    asn: 12
    router_id: 90.1.1.4
    maxpath_ibgp: 2
    maxpath_ebgp: 2
    graceful_restart: true
    best_path:
       as_path: ignore
       as_path_state: present
       ignore_router_id: true
       med:
        - attribute: confed
          state: present
    ipv4_network:
       - address: 101.1.1.0/30
         delete: False
    ipv6_network:
      - address: "2001:4898:5808:ffa0::/126"
        state: present
    neighbor:
      - type: ipv4
        remote_asn: 11
        ip: 192.168.10.1
        peergroup: peer1
        peergroup_state: present
        adv_interval: 40
        fall_over: present
        state: present
      - type: ipv4
        remote_asn: 13
        ip: 192.168.12.3
        state: present
      - name: peer1
        type: peergroup
        remote_asn: 12
        passive: True
        subnet: 10.128.4.192/27
        state: present
      - type: ipv6
        remote_asn: 14
        ip: 2001:4898:5808:ffa2::1
        state: present
    redistribute:
      - route_type: static
        route_map_name: aa
        route_map: present
        address_type: ipv4
        state: present
    state: present

################################}
{% if dellos_bgp is defined and dellos_bgp %}
{% set bgp_vars = dellos_bgp %}
{% if bgp_vars.state is defined and bgp_vars.state == "absent" %}
no router bgp
{% else %}
  {# Add Feature to the switch #}
  {% if bgp_vars.asn is defined and bgp_vars.asn %}
router bgp {{ bgp_vars.asn }}
    {% if bgp_vars.router_id is defined %}
      {% if bgp_vars.router_id %}
 router-id {{ bgp_vars.router_id }}
      {% else %}
 no router-id
      {% endif %}
    {% endif %}

    {% if bgp_vars.maxpath_ebgp is defined %}
      {% if bgp_vars.maxpath_ebgp %}
 maximum-paths ebgp {{ bgp_vars.maxpath_ebgp }}
      {% else %}
 no maximum-paths ebgp
      {% endif %}
    {% endif %}

    {% if bgp_vars.maxpath_ibgp is defined %}
      {% if bgp_vars.maxpath_ibgp %}
 maximum-paths ibgp {{ bgp_vars.maxpath_ibgp }}
      {% else %}
 no maximum-paths ibgp
      {% endif %}
    {% endif %}

    {% if bgp_vars.graceful_restart is defined %}
      {% if bgp_vars.graceful_restart %}
 graceful-restart role receiver-only
      {% else %}
 no graceful-restart role receiver-only
      {% endif %}
    {% endif %}

    {% if bgp_vars.best_path is defined and bgp_vars.best_path %}
      {% if bgp_vars.best_path.as_path is defined and bgp_vars.best_path.as_path %}
        {% if bgp_vars.best_path.as_path_state is defined and bgp_vars.best_path.as_path_state == "absent" %}
 no bestpath as-path {{ bgp_vars.best_path.as_path }}
        {% else %}
 bestpath as-path {{ bgp_vars.best_path.as_path }}
        {% endif %}
      {% endif %}
      {% if bgp_vars.best_path.ignore_router_id is defined %}
        {% if bgp_vars.best_path.ignore_router_id %}
 bestpath router-id ignore
        {% else %}
 no bestpath router-id ignore
        {% endif %}
      {% endif %}
      {% if bgp_vars.best_path.med is defined and bgp_vars.best_path.med %}
        {% for med in bgp_vars.best_path.med %}
          {% if med.attribute is defined and med.attribute %}
            {% if med.state is defined and med.state == "absent" %}
 no bestpath med {{ med.attribute }}
            {% else %}
 bestpath med {{ med.attribute }}
            {% endif %}
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endif %}

    {% if bgp_vars.ipv4_network is defined and bgp_vars.ipv4_network %}
 address-family ipv4 unicast
      {% for net in bgp_vars.ipv4_network %}
        {% if net.address is defined and net.address %}
          {% if net.state is defined and net.state == "absent"%}
  no network {{ net.address }}
          {% else %}
  network {{ net.address }}
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}

    {% if bgp_vars.ipv6_network is defined and bgp_vars.ipv6_network %}
 address-family ipv6 unicast
      {% for net in bgp_vars.ipv6_network %}
        {% if net.address is defined and net.address %}
          {% if net.state is defined and net.state == "absent"%}
  no network {{ net.address }}
          {% else %}
  network {{ net.address }}
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}

    {% if bgp_vars.redistribute is defined and bgp_vars.redistribute %}
      {% for route in bgp_vars.redistribute %}
        {% if route.route_type is defined  and route.route_type %}
          {% if route.address_type is defined and route.address_type %}
 address-family {{ route.address_type }} unicast
            {% if route.state is defined and route.state == "absent" %}
  no redistribute {{ route.route_type }}
            {% else %}
              {% if route.route_map_name is defined and route.route_map_name %}
                {% if route.route_map is defined and route.route_map == "absent" %}
  no redistribute {{ route.route_type }} route-map {{ route.route_map_name }}
                {% else %}
  redistribute {{ route.route_type }} route-map {{ route.route_map_name }}
                {% endif %}
              {% else %}
  redistribute {{ route.route_type }}
              {% endif %}
            {% endif %}
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}

  {% if bgp_vars.neighbor is defined and bgp_vars.neighbor %}
    {% for neighbor in bgp_vars.neighbor %}
      {% if neighbor.type is defined  %}
        {% if neighbor.type == "ipv4" or neighbor.type =="ipv6" %}
          {% if neighbor.ip is defined and neighbor.ip %}
            {% set tag_or_ip = neighbor.ip %}
              {% if neighbor.state is defined and neighbor.state == "absent" %}
 no neighbor {{ tag_or_ip }}
              {% else %}
 neighbor {{ tag_or_ip }}
                {% if neighbor.peergroup is defined and neighbor.peergroup %}
                  {% if neighbor.peergroup_state is defined and neighbor.peergroup_state == "absent" %}
  no inherit template {{ neighbor.peergroup }}
                  {% else %}
  inherit template {{ neighbor.peergroup }}
                  {% endif %}
                {% endif %}
              {% endif %}
          {% endif %}
        {% elif neighbor.type == "peergroup" %}
          {% if neighbor.name is defined and neighbor.name %}
            {% set tag_or_ip = neighbor.name %}
            {% if neighbor.state is defined and neighbor.state == "absent" %}
 no template {{ tag_or_ip }}
            {% else %}
 template {{ tag_or_ip }}
              {% if neighbor.subnet is defined and neighbor.subnet %}
                {% if neighbor.subnet_state is defined and neighbor.subnet_state =="absent" %}
  no listen {{ neighbor.subnet }}
                {% else %}
  listen {{ neighbor.subnet }}
                {% endif %}
              {% endif %}
            {% endif %}
          {% endif %}
        {% endif %}
        {% if tag_or_ip is defined and tag_or_ip %}
          {% if neighbor.state is defined and not neighbor.state == "absent" %}
            {% if neighbor.remote_asn is defined and neighbor.remote_asn %}
              {% if neighbor.remote_asn_state is defined and neighbor.remote_asn_state == "absent" %}
  no remote-as {{ neighbor.remote_asn }}
              {% else %}
  remote-as {{ neighbor.remote_asn }}
              {% endif %}
            {% endif %}
            {% if neighbor.ebgp_multihop is defined %}
              {% if neighbor.ebgp_multihop %}
  ebgp-multihop {{ neighbor.ebgp_multihop }}
              {% else %}
  no ebgp-multihop
              {% endif %}
            {% endif %}
            {% if neighbor.adv_interval is defined %}
              {% if neighbor.adv_interval %}
  advertisement-interval {{ neighbor.adv_interval }}
              {% else %}
  no advertisement-interval
              {% endif %}
            {% endif %}
            {% if neighbor.fall_over is defined and neighbor.fall_over == "present" %}
  fall-over
            {% elif neighbor.fall_over is defined and neighbor.fall_over == "absent" %}
  no fall-over
            {% endif %}

            {% if neighbor.timer is defined %}
              {% if neighbor.timer %}
  timers {{ neighbor.timer }}
              {% else %}
  no timers
              {% endif %}
            {% endif %}
            {% if neighbor.connection_retry_timer is defined %}
              {% if neighbor.connection_retry_timer %}
  connection-retry-timer {{ neighbor.connection_retry_timer }}
              {% else %}
  no connection-retry-timer
              {% endif %}
            {% endif %}
            {% if neighbor.admin is defined %}
              {% if neighbor.admin == "up" %}
  no shutdown
              {% else %}
  shutdown
              {% endif %}
            {% endif %}
            {% if neighbor.distribute_list is defined and neighbor.distribute_list %}
  address-family ipv4 unicast
              {% if neighbor.distribute_list.in is defined and neighbor.distribute_list.in %}
                 {% if neighbor.distribute_list.in_state is defined and neighbor.distribute_list.in_state == "absent" %}
   no distribute-list {{ neighbor.distribute_list.in }} in
                {% else %} 
   distribute-list {{ neighbor.distribute_list.in }} in
                {% endif %}
              {% endif %}
              {% if neighbor.distribute_list.out is defined and neighbor.distribute_list.out %}
               {% if neighbor.distribute_list.out_state is defined and neighbor.distribute_list.out_state == "absent" %}
   no distribute-list {{ neighbor.distribute_list.out }} out
                {% else %}
   distribute-list {{ neighbor.distribute_list.out }} out
                {% endif %}
              {% endif %}
            {% endif %}
            {% if neighbor.sender_loop_detect is defined %}
  address-family ipv4 unicast
              {% if neighbor.sender_loop_detect %}
   sender-side-loop-detection
              {% else %}
   no sender-side-loop-detection
              {% endif %}
            {% endif %}

          {% endif %}
        {% endif %}
      {% endif %}
    {% endfor %}
  {% endif %}


  {% endif %}
{% endif %}
{% endif %}
